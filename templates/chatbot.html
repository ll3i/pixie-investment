{% extends "layout.html" %}

{% block title %}Pixie - AI íˆ¬ì ì–´ë“œë°”ì´ì €{% endblock %}

{% block extra_css %}
<style>
    /* Pixie Chat Interface Styles */
    .pixie-chatbot-container {
        padding: 40px 20px;
        max-width: 900px;
        margin: 0 auto;
        min-height: calc(100vh - 200px);
    }
    
    .pixie-chat-wrapper {
        background: white;
        border-radius: 24px;
        overflow: hidden;
        height: 90vh;
        max-height: 900px;
        min-height: 600px;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }
    
    .pixie-chat-header {
        background: var(--gradient-primary);
        padding: 16px 24px;
        display: flex;
        align-items: center;
        color: white;
        flex-shrink: 0;
    }
    
    .pixie-chat-avatar {
        width: 48px;
        height: 48px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 16px;
        font-size: 20px;
        backdrop-filter: blur(10px);
    }
    
    .pixie-chat-info h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
        color: white;
    }
    
    .pixie-chat-info p {
        margin: 4px 0 0;
        font-size: 14px;
        opacity: 0.9;
        color: white;
    }
    
    .pixie-chat-close {
        margin-left: auto;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .pixie-chat-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .pixie-chat-messages {
        flex-grow: 1;
        padding: 24px;
        overflow-y: auto;
        background: var(--light-color);
        display: flex;
        flex-direction: column;
        gap: 16px;
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) transparent;
    }
    
    .pixie-chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    .pixie-chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .pixie-chat-messages::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 3px;
    }
    
    .pixie-message {
        max-width: 75%;
        animation: pixieMessageSlide 0.3s ease-out;
        position: relative;
    }
    
    @keyframes pixieMessageSlide {
        from { 
            opacity: 0; 
            transform: translateY(10px); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0); 
        }
    }
    
    .pixie-message-user {
        background: var(--gradient-primary);
        color: white;
        padding: 16px 20px;
        border-radius: 20px 20px 4px 20px;
        margin-left: auto;
        box-shadow: var(--shadow-sm);
        font-size: 15px;
        line-height: 1.5;
        word-wrap: break-word;
    }
    
    .pixie-message-ai {
        background: white;
        color: var(--text-primary);
        padding: 16px 20px;
        border-radius: 20px 20px 20px 4px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        font-size: 15px;
        line-height: 1.6;
        word-wrap: break-word;
    }
    
    .pixie-message-ai .message-content p {
        margin-bottom: 12px;
    }
    
    .pixie-message-ai .message-content p:last-child {
        margin-bottom: 0;
    }
    
    /* AI ì—ì´ì „íŠ¸ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .pixie-message-agent {
        background: #f0f7ff;
        color: var(--text-primary);
        padding: 16px 20px;
        border-radius: 20px 20px 20px 4px;
        box-shadow: var(--shadow-sm);
        border: 1px solid #cce5ff;
        font-size: 15px;
        line-height: 1.6;
        word-wrap: break-word;
        margin-bottom: 12px;
    }
    
    .agent-label {
        font-weight: 700;
        color: #1454FE;
        font-size: 13px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .agent-label .agent-icon {
        width: 20px;
        height: 20px;
        background: #1454FE;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 900;
    }
    
    .pixie-message-agent.agent-a2 {
        background: #fff5e6;
        border-color: #ffd6a5;
    }
    
    .pixie-message-agent.agent-a2 .agent-label {
        color: #ff8c00;
    }
    
    .pixie-message-agent.agent-a2 .agent-icon {
        background: #ff8c00;
    }
    
    .pixie-message-agent.agent-b {
        background: #e6f9f5;
        border-color: #a5e5d6;
    }
    
    .pixie-message-agent.agent-b .agent-label {
        color: #00a884;
    }
    
    .pixie-message-agent.agent-b .agent-icon {
        background: #00a884;
    }
    
    .agent-conversation-divider {
        text-align: center;
        margin: 20px 0;
        position: relative;
    }
    
    .agent-conversation-divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: var(--border-color);
    }
    
    .agent-conversation-divider span {
        background: var(--light-color);
        padding: 0 16px;
        color: var(--text-secondary);
        font-size: 13px;
        position: relative;
        font-weight: 500;
    }
    
    .pixie-typing-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 16px 20px;
        background: white;
        border-radius: 20px 20px 20px 4px;
        max-width: 70px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
    }
    
    .pixie-typing-dot {
        width: 6px;
        height: 6px;
        background-color: var(--primary-color);
        border-radius: 50%;
        animation: pixieTyping 1.4s infinite ease-in-out;
    }
    
    .pixie-typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .pixie-typing-dot:nth-child(2) { animation-delay: -0.16s; }
    .pixie-typing-dot:nth-child(3) { animation-delay: 0s; }
    
    @keyframes pixieTyping {
        0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    .pixie-chat-input-container {
        background: white;
        padding: 16px 20px;
        border-top: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
    }
    
    .pixie-chat-input {
        flex-grow: 1;
        background: var(--light-color);
        border: 2px solid var(--border-color);
        border-radius: 22px;
        padding: 12px 18px;
        color: var(--text-primary);
        font-size: 14px;
        outline: none;
        transition: all 0.2s ease;
        font-family: inherit;
    }
    
    .pixie-chat-input::placeholder {
        color: var(--text-secondary);
    }
    
    .pixie-chat-input:focus {
        border-color: var(--primary-color);
        background: white;
        box-shadow: 0 0 0 3px rgba(20, 84, 254, 0.1);
    }
    
    .pixie-send-button {
        background: var(--gradient-primary);
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
        flex-shrink: 0;
    }
    
    .pixie-send-button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .pixie-send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .pixie-suggestions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        padding: 12px 20px 8px;
        background: white;
        flex-shrink: 0;
    }
    
    .pixie-suggestion-chip {
        background: var(--light-color);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 6px 14px;
        color: var(--text-secondary);
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
    }
    
    .pixie-suggestion-chip:hover {
        background: var(--primary-light);
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateY(-1px);
    }
    
    @media (max-width: 768px) {
        .pixie-chatbot-container {
            padding: 20px 16px;
        }
        
        .pixie-chat-wrapper {
            height: 92vh;
            border-radius: 16px;
        }
        
        .pixie-chat-header {
            padding: 20px;
        }
        
        .pixie-chat-messages {
            padding: 16px;
        }
        
        .pixie-message {
            max-width: 85%;
        }
        
        .pixie-chat-input-container {
            padding: 16px;
        }
        
        .pixie-suggestions {
            padding: 12px 16px 8px;
        }
        
        .pixie-suggestion-chip {
            padding: 6px 12px;
            font-size: 13px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="pixie-chatbot-container">
    <div class="pixie-chat-wrapper">
        <div class="pixie-chat-header">
            <div class="pixie-chat-avatar">
                âœ¨
            </div>
            <div class="pixie-chat-info">
                <h2>Pixie AI ì–´ë“œë°”ì´ì €</h2>
                <p>íˆ¬ìì— ëŒ€í•œ ëª¨ë“  ì§ˆë¬¸ì— ë‹µë³€í•´ë“œë¦½ë‹ˆë‹¤</p>
            </div>
            <button class="pixie-chat-close" onclick="window.location.href='/'">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="pixie-chat-messages" id="chatMessages">
            <!-- ì´ˆê¸° ë©”ì‹œì§€ëŠ” JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
        
        <div class="pixie-chat-input-container">
            <input type="text" class="pixie-chat-input" id="chatInput" placeholder="íˆ¬ìì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”...">
            <button type="button" class="pixie-send-button" id="sendButton" style="background: #1454FE;">
                ì „ì†¡
            </button>
        </div>
        
        <!-- AI Status Indicator -->
        <div class="pixie-ai-status" id="aiStatus" style="display: none; background: #f5f5f5; padding: 8px 24px; text-align: center; font-size: 14px; color: #666; border-top: 1px solid #e5e5e5;">
            <span id="aiStatusText">AI-A is thinking...</span>
        </div>
        
        <div class="pixie-suggestions">
            <div class="pixie-suggestion-chip" data-suggestion="ë‚˜ì˜ íˆ¬ì ì„±í–¥ì— ì–´ìš¸ë¦¬ëŠ” ì£¼ì‹ ì¶”ì²œí•´ì¤˜">íˆ¬ì ì„±í–¥ ê¸°ë°˜ ì¶”ì²œ</div>
            <div class="pixie-suggestion-chip" data-suggestion="í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±ë²•">í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±</div>
            <div class="pixie-suggestion-chip" data-suggestion="ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë°©ë²•">ë¦¬ìŠ¤í¬ ê´€ë¦¬</div>
            <div class="pixie-suggestion-chip" data-suggestion="ì˜¤ëŠ˜ì˜ ì‹œì¥ ë¶„ì„">ì‹œì¥ ë¶„ì„</div>
        </div>
        
        <!-- ì‹œì¥ ë¶„ì„ ë²„íŠ¼ -->
        <div style="padding: 12px 20px; border-top: 1px solid var(--border-color); background: white; flex-shrink: 0;">
            <button type="button" id="marketAnalysisBtn" onclick="requestMarketAnalysis()" style="
                width: 100%;
                padding: 10px 20px;
                background: linear-gradient(135deg, #1454FE 0%, #0F43C9 100%);
                color: white;
                border: none;
                border-radius: 20px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(20, 84, 254, 0.2);
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(20, 84, 254, 0.3)';" 
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(20, 84, 254, 0.2)';"
               onmousedown="this.style.transform='translateY(0)';"
               onmouseup="this.style.transform='translateY(-2px)';">
                <span style="font-size: 18px;">ğŸ“Š</span>
                ì‹¤ì‹œê°„ ì‹œì¥ ë¶„ì„ (AI ë‰´ìŠ¤ ë¶„ì„ ê¸°ë°˜)
            </button>
            <p style="text-align: center; color: #666; font-size: 12px; margin-top: 6px; margin-bottom: 4px;">
                ìµœì‹  ë‰´ìŠ¤ ê°ì • ë¶„ì„ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì‹œì¥ ë™í–¥ì„ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let chatHistory = [];
let isTyping = false;

// ì„¸ì…˜ ID ìƒì„± ë° ê´€ë¦¬
function getSessionId() {
    let sessionId = localStorage.getItem('chatbot_session_id');
    if (!sessionId) {
        // UUID í˜•íƒœì˜ ì„¸ì…˜ ID ìƒì„±
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('chatbot_session_id', sessionId);
    }
    return sessionId;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë° ì±„íŒ… ê¸°ë¡ ë¡œë“œ
document.addEventListener('DOMContentLoaded', function() {
    // ì „ì†¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const sendButton = document.getElementById('sendButton');
    if (sendButton) {
        sendButton.addEventListener('click', sendMessage);
    }
    
    // ì…ë ¥ í•„ë“œ ì—”í„° í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.addEventListener('keypress', handleKeyPress);
    }
    
    // ì œì•ˆ ì¹© ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const suggestionChips = document.querySelectorAll('.pixie-suggestion-chip');
    suggestionChips.forEach(chip => {
        chip.addEventListener('click', function() {
            const suggestion = this.getAttribute('data-suggestion');
            sendSuggestion(suggestion);
        });
    });
    
    // í”„ë¡œí•„ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸° ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
    checkProfileStatus();
    // ì±„íŒ… ê¸°ë¡ì€ ì´ˆê¸° ë©”ì‹œì§€ í‘œì‹œ í›„ì— ë¡œë“œ
    setTimeout(() => {
        loadChatHistory();
    }, 100);
    
    // ì„¤ë¬¸ ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const viewResultsButton = document.getElementById('viewSurveyResults');
    if (viewResultsButton) {
        viewResultsButton.addEventListener('click', showSurveyResults);
    }
});

async function checkProfileStatus() {
    try {
        const response = await fetch('/api/profile-status');
        const data = await response.json();
        
        const chatMessages = document.getElementById('chatMessages');
        
        // ê¸°ì¡´ ë©”ì‹œì§€ê°€ ì—†ì„ ë•Œë§Œ ì¶”ê°€
        if (chatMessages.children.length === 0) {
            const initialMessage = document.createElement('div');
            initialMessage.className = 'pixie-message pixie-message-ai';
            initialMessage.innerHTML = `
                <div class="message-content">
                    <p>ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” Pixie AI íˆ¬ì ì–´ë“œë°”ì´ì €ì…ë‹ˆë‹¤. íˆ¬ìì— ê´€í•œ ëª¨ë“  ì§ˆë¬¸ì— ë‹µë³€í•´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <p>ë¨¼ì € íˆ¬ì ì„±í–¥ ì„¤ë¬¸ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”! ì„¤ë¬¸ì´ ëë‚˜ë©´ ë§ì¶¤í˜• ë¶„ì„ê³¼ í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ì²œì„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <div style="display: flex; gap: 10px; margin-top: 12px;">
                        <a href="/survey" class="pixie-survey-button" style="display: inline-block; padding: 10px 20px; background: #1454FE; color: white; text-decoration: none; border-radius: 20px; font-weight: 500;">íˆ¬ì ì„¤ë¬¸ ì‹œì‘í•˜ê¸°</a>
                        <a href="#" class="pixie-survey-results-button" onclick="showSurveyResults(event)" style="display: inline-block; padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 20px; font-weight: 500;">ì„¤ë¬¸ ê²°ê³¼ ë³´ê¸°</a>
                    </div>
                </div>
            `;
            chatMessages.appendChild(initialMessage);
        }
    } catch (error) {
        console.error('í”„ë¡œí•„ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
    }
}

function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function sendMessage() {
    console.log('sendMessage called');
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    console.log('Message:', message, 'isTyping:', isTyping);
    
    if (!message || isTyping) return;
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    addMessage(message, 'user');
    input.value = '';
    
    // AI ì‘ë‹µ ìƒì„±
    generateAIResponse(message);
}

function sendSuggestion(text) {
    document.getElementById('chatInput').value = text;
    sendMessage();
}

function addMessage(content, sender) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `pixie-message pixie-message-${sender}`;
    
    if (sender === 'user') {
        messageDiv.innerHTML = `<div class="message-content">${content}</div>`;
    } else {
        messageDiv.innerHTML = `<div class="message-content"><p>${content}</p></div>`;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // ì±„íŒ… ê¸°ë¡ì— ì¶”ê°€
    chatHistory.push({ sender, content, timestamp: new Date().toISOString() });
    saveChatHistory();
}

function addAgentMessage(content, agent) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    
    // ì—ì´ì „íŠ¸ì— ë”°ë¥¸ í´ë˜ìŠ¤ ì„¤ì •
    let agentClass = '';
    let agentLabel = '';
    let agentIcon = '';
    
    if (agent === 'AI-A2') {
        agentClass = 'agent-a2';
        agentLabel = 'AI-A2 (íˆ¬ì ë¶„ì„ê°€)';
        agentIcon = 'A2';
    } else if (agent === 'AI-B') {
        agentClass = 'agent-b';
        agentLabel = 'AI-B (ê¸ˆìœµ ë°ì´í„° ì „ë¬¸ê°€)';
        agentIcon = 'B';
    } else {
        agentClass = '';
        agentLabel = agent;
        agentIcon = 'AI';
    }
    
    messageDiv.className = `pixie-message pixie-message-agent ${agentClass}`;
    messageDiv.innerHTML = `
        <div class="agent-label">
            <span class="agent-icon">${agentIcon}</span>
            ${agentLabel}
        </div>
        <div class="message-content">${content}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // ì±„íŒ… ê¸°ë¡ì— ì¶”ê°€ (ì—ì´ì „íŠ¸ ë©”ì‹œì§€ë„ ì €ì¥)
    chatHistory.push({ 
        sender: 'agent', 
        agent: agent,
        content, 
        timestamp: new Date().toISOString() 
    });
    saveChatHistory();
}

function showTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'pixie-typing-indicator';
    typingDiv.id = 'typingIndicator';
    typingDiv.innerHTML = `
        <div class="pixie-typing-dot"></div>
        <div class="pixie-typing-dot"></div>
        <div class="pixie-typing-dot"></div>
    `;
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

async function generateAIResponse(userMessage) {
    isTyping = true;
    showTypingIndicator();
    
    try {
        // Check for survey status using EventSource for streaming updates
        const eventSource = new EventSource(`/api/chat-stream?message=${encodeURIComponent(userMessage)}`);
        let fullResponse = '';
        let currentAgent = '';
        let agentResponses = {}; // Store responses from each agent
        
        eventSource.addEventListener('status', function(event) {
            const data = JSON.parse(event.data);
            if (data.agent && data.status === 'thinking') {
                showAIStatus(`${data.agent} is thinking...`);
                currentAgent = data.agent;
            }
        });
        
        // New event listener for agent responses
        eventSource.addEventListener('agent_response', function(event) {
            const data = JSON.parse(event.data);
            if (data.agent && data.content) {
                hideTypingIndicator();
                // Add agent response to chat
                addAgentMessage(data.content, data.agent);
                agentResponses[data.agent] = data.content;
                // Show typing indicator for next agent
                if (data.agent !== 'Final') {
                    showTypingIndicator();
                }
            }
        });
        
        eventSource.addEventListener('message', function(event) {
            const data = JSON.parse(event.data);
            if (data.content) {
                fullResponse += data.content;
            }
        });
        
        eventSource.addEventListener('complete', function(event) {
            hideTypingIndicator();
            hideAIStatus();
            eventSource.close();
            
            // If we have agent responses, add a divider before final response
            if (Object.keys(agentResponses).length > 0 && fullResponse) {
                // Add conversation divider
                const chatMessages = document.getElementById('chatMessages');
                const divider = document.createElement('div');
                divider.className = 'agent-conversation-divider';
                divider.innerHTML = '<span>ìµœì¢… ë‹µë³€</span>';
                chatMessages.appendChild(divider);
                
                // Add final response with agent conversation summary
                let finalMessageContent = fullResponse;
                
                // Optional: Add brief summary of agent conversation
                if (agentResponses['AI-A2'] || agentResponses['AI-B']) {
                    finalMessageContent = `<p>${fullResponse}</p>`;
                    finalMessageContent += `<div style="margin-top: 15px; padding: 10px; background: #f0f7ff; border-radius: 8px; font-size: 13px; color: #666;">`;
                    finalMessageContent += `<strong>AI ë¶„ì„ ìš”ì•½:</strong><br>`;
                    if (agentResponses['AI-A2']) {
                        finalMessageContent += `â€¢ AI-A2ê°€ íˆ¬ì ì„±í–¥ì„ ë¶„ì„í•˜ì—¬ ë§ì¶¤í˜• ì •ë³´ë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.<br>`;
                    }
                    if (agentResponses['AI-B']) {
                        finalMessageContent += `â€¢ AI-Bê°€ ì‹¤ì‹œê°„ ê¸ˆìœµ ë°ì´í„°ë¥¼ ì œê³µí–ˆìŠµë‹ˆë‹¤.`;
                    }
                    finalMessageContent += `</div>`;
                }
                
                addMessage(finalMessageContent, 'ai');
            } else if (Object.keys(agentResponses).length === 0 && fullResponse) {
                // No agent responses, show the full response
                addMessage(fullResponse, 'ai');
            }
            isTyping = false;
        });
        
        eventSource.addEventListener('error', function(event) {
            console.error('EventSource error:', event);
            eventSource.close();
            // Fallback to regular POST
            generateAIResponseFallback(userMessage);
        });
        
    } catch (error) {
        console.error('Error:', error);
        generateAIResponseFallback(userMessage);
    }
}

async function generateAIResponseFallback(userMessage) {
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: userMessage,
                session_id: 'chatbot_session'
            })
        });
        
        const data = await response.json();
        
        hideTypingIndicator();
        hideAIStatus();
        
        if (data.success) {
            addMessage(data.response, 'ai');
            if (data.require_survey) {
                // Add survey button if needed
                const chatMessages = document.getElementById('chatMessages');
                const surveyBtn = document.createElement('div');
                surveyBtn.innerHTML = '<a href="/survey" class="pixie-survey-button" style="display: inline-block; margin: 12px 0; padding: 10px 20px; background: #1454FE; color: white; text-decoration: none; border-radius: 20px; font-weight: 500;">íˆ¬ì ì„¤ë¬¸ ì‹œì‘í•˜ê¸°</a>';
                chatMessages.appendChild(surveyBtn);
            }
        } else {
            addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ai');
        }
    } catch (error) {
        console.error('Error:', error);
        hideTypingIndicator();
        hideAIStatus();
        addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ai');
    }
    
    isTyping = false;
}

function loadChatHistory() {
    fetch('/api/chat-history')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.history && data.history.length > 0) {
                // ê¸°ë³¸ ë©”ì‹œì§€ëŠ” ì œì™¸í•˜ê³  ì‹¤ì œ ëŒ€í™” ë‚´ìš©ë§Œ í‘œì‹œ
                const filteredHistory = data.history.filter(msg => {
                    return !msg.content.includes('í˜„ì¬ ê·€í•˜ì˜ íˆ¬ì ì„±í–¥ì„ ê³ ë ¤í•œ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤:') &&
                           !msg.content.includes('ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” Pixie AI íˆ¬ì ì–´ë“œë°”ì´ì €ì…ë‹ˆë‹¤.');
                });
                
                if (filteredHistory.length > 0) {
                    chatHistory = filteredHistory;
                    // ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ ì´ˆê¸°í™”
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    
                    // ì´ˆê¸° ë©”ì‹œì§€ ë‹¤ì‹œ ì¶”ê°€
                    const initialMessage = document.createElement('div');
                    initialMessage.className = 'pixie-message pixie-message-ai';
                    initialMessage.innerHTML = `
                        <div class="message-content">
                            <p>ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” Pixie AI íˆ¬ì ì–´ë“œë°”ì´ì €ì…ë‹ˆë‹¤. íˆ¬ìì— ê´€í•œ ëª¨ë“  ì§ˆë¬¸ì— ë‹µë³€í•´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            <p>ë¨¼ì € íˆ¬ì ì„±í–¥ ì„¤ë¬¸ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”! ì„¤ë¬¸ì´ ëë‚˜ë©´ ë§ì¶¤í˜• ë¶„ì„ê³¼ í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ì²œì„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            <div style="display: flex; gap: 10px; margin-top: 12px;">
                                <a href="/survey" class="pixie-survey-button" style="display: inline-block; padding: 10px 20px; background: #1454FE; color: white; text-decoration: none; border-radius: 20px; font-weight: 500;">íˆ¬ì ì„¤ë¬¸ ì‹œì‘í•˜ê¸°</a>
                                <a href="#" class="pixie-survey-results-button" onclick="showSurveyResults(event)" style="display: inline-block; padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 20px; font-weight: 500;">ì„¤ë¬¸ ê²°ê³¼ ë³´ê¸°</a>
                            </div>
                        </div>
                    `;
                    chatMessages.appendChild(initialMessage);
                    
                    // ì±„íŒ… ê¸°ë¡ì„ í™”ë©´ì— í‘œì‹œ
                    filteredHistory.forEach(msg => {
                        if (msg.sender === 'agent' && msg.agent) {
                            // ì—ì´ì „íŠ¸ ë©”ì‹œì§€
                            addAgentMessage(msg.content, msg.agent);
                        } else {
                            // ì¼ë°˜ ë©”ì‹œì§€
                            addMessage(msg.content, msg.speaker || msg.sender);
                        }
                    });
                }
            }
        })
        .catch(error => {
            console.error('ì±„íŒ… ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        });
}

function saveChatHistory() {
    // ì±„íŒ… ê¸°ë¡ì„ ì„œë²„ì— ì €ì¥
    fetch('/api/chat-history', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            history: chatHistory
        })
    }).catch(error => {
        console.error('ì±„íŒ… ê¸°ë¡ ì €ì¥ ì˜¤ë¥˜:', error);
    });
}

function showAIStatus(text) {
    const aiStatus = document.getElementById('aiStatus');
    const aiStatusText = document.getElementById('aiStatusText');
    if (aiStatus && aiStatusText) {
        aiStatusText.textContent = text;
        aiStatus.style.display = 'block';
    }
}

function hideAIStatus() {
    const aiStatus = document.getElementById('aiStatus');
    if (aiStatus) {
        aiStatus.style.display = 'none';
    }
}

async function showSurveyResults(event) {
    if (event) event.preventDefault();
    
    try {
        // í”„ë¡œí•„ ìƒíƒœ í™•ì¸
        const statusResponse = await fetch('/api/profile-status');
        const statusData = await statusResponse.json();
        
        if (!statusData.success || !statusData.has_profile) {
            addMessage('ì•„ì§ íˆ¬ì ì„¤ë¬¸ì„ ì™„ë£Œí•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤. ë¨¼ì € ì„¤ë¬¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.', 'ai');
            return;
        }
        
        // í”„ë¡œí•„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const profileResponse = await fetch('/api/profile');
        const profileData = await profileResponse.json();
        
        if (profileData.success && profileData.profile) {
            const profile = profileData.profile;
            
            // íˆ¬ì ì„±í–¥ ë¶„ì„ ê²°ê³¼ ë©”ì‹œì§€ ìƒì„±
            let resultMessage = '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px;">';
            resultMessage += '<h3 style="color: #1454FE; margin-bottom: 20px;">ğŸ“Š íˆ¬ì ì„±í–¥ ë¶„ì„ ê²°ê³¼</h3>';
            
            // Risk Tolerance
            resultMessage += '<div style="margin-bottom: 15px;">';
            resultMessage += '<h4 style="color: #333; margin-bottom: 5px;">Risk Tolerance</h4>';
            resultMessage += '<p style="color: #666; line-height: 1.6;">';
            resultMessage += `ìœ„í—˜ ê°ìˆ˜ì„± ì ìˆ˜ê°€ <strong>${profile.risk_score || 0}ì </strong>ìœ¼ë¡œ ë‚˜ì™”ìŠµë‹ˆë‹¤. `;
            
            if (profile.risk_score >= 4) {
                resultMessage += 'ì´ëŠ” íˆ¬ììê°€ ë†’ì€ ìœ„í—˜ì„ ê°ìˆ˜í•˜ëŠ” ê²ƒì„ ê·¹ë„ë¡œ ì‹«ì–´í•œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì„±í–¥ì€ ì•ˆì •ì ì¸ íˆ¬ìë¥¼ ì„ í˜¸í•˜ê²Œ ë§Œë“¤ì§€ë§Œ, ë†’ì€ ìˆ˜ìµì„ ì–»ì„ ìˆ˜ ìˆëŠ” ê¸°íšŒë¥¼ ë†“ì¹˜ê²Œ ë  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.';
            } else if (profile.risk_score >= 2) {
                resultMessage += 'ì´ëŠ” íˆ¬ììê°€ ì ì ˆí•œ ìˆ˜ì¤€ì˜ ìœ„í—˜ì„ ê°ìˆ˜í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ê· í˜•ì¡íŒ í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
            } else {
                resultMessage += 'ì´ëŠ” íˆ¬ììê°€ ë†’ì€ ìœ„í—˜ì„ ê¸°êº¼ì´ ê°ìˆ˜í•œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ê³ ìˆ˜ìµ ê³ ìœ„í—˜ íˆ¬ìì— ì í•©í•˜ì§€ë§Œ, ì†ì‹¤ ìœ„í—˜ë„ í½ë‹ˆë‹¤.';
            }
            resultMessage += '</p></div>';
            
            // Investment Time Horizon
            resultMessage += '<div style="margin-bottom: 15px;">';
            resultMessage += '<h4 style="color: #333; margin-bottom: 5px;">Investment Time Horizon</h4>';
            resultMessage += '<p style="color: #666; line-height: 1.6;">';
            
            const timeScore = profile.answers?.q2 || 1;
            resultMessage += `íˆ¬ì ì‹œê°„ ë²”ìœ„ ì ìˆ˜ê°€ <strong>${timeScore === 1 ? '-1.0' : timeScore === 2 ? '0' : '1.0'}ì </strong>ìœ¼ë¡œ ë‚˜ì™”ìŠµë‹ˆë‹¤. `;
            
            if (timeScore <= 2) {
                resultMessage += 'ì´ëŠ” íˆ¬ììê°€ ë‹¨ê¸°ì ì¸ ìˆ˜ìµì„ ì¶”êµ¬í•˜ëŠ” ê²½í–¥ì´ ìˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ë‹¨ê¸°ì ì¸ íˆ¬ìëŠ” ë†’ì€ ìœ„í—˜ì„ ê°ìˆ˜í•´ì•¼ í•˜ë©°, ì¥ê¸°ì ì¸ íˆ¬ìì— ë¹„í•´ ìˆ˜ìµë¥ ì´ ë‚®ì„ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.';
            } else {
                resultMessage += 'ì´ëŠ” íˆ¬ììê°€ ì¥ê¸°ì ì¸ íˆ¬ìë¥¼ ì„ í˜¸í•œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì¥ê¸°ì ì¸ íˆ¬ìëŠ” ì‹œì¥ ë³€ë™ì„±ì„ ê·¹ë³µí•˜ê³  ì•ˆì •ì ì¸ ìˆ˜ìµì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }
            resultMessage += '</p></div>';
            
            // Financial Goal Orientation
            resultMessage += '<div style="margin-bottom: 15px;">';
            resultMessage += '<h4 style="color: #333; margin-bottom: 5px;">Financial Goal Orientation</h4>';
            resultMessage += '<p style="color: #666; line-height: 1.6;">';
            
            const goalScore = profile.answers?.q5 || 1;
            resultMessage += `ì¬ë¬´ ëª©í‘œ ì§€í–¥ì„± ì ìˆ˜ê°€ <strong>${goalScore === 1 ? '-2.0' : goalScore === 2 ? '-1.0' : goalScore === 3 ? '0' : goalScore === 4 ? '1.0' : '2.0'}ì </strong>ìœ¼ë¡œ ë‚˜ì™”ìŠµë‹ˆë‹¤. `;
            
            resultMessage += 'ì´ëŠ” íˆ¬ììê°€ ëª…í™•í•œ ì¬ë¬´ ëª©í‘œë¥¼ ê°€ì§€ê³  ìˆì§€ ì•Šì„ ê°€ëŠ¥ì„±ì´ ë†’ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì¬ë¬´ ëª©í‘œê°€ ëª…í™•í•˜ì§€ ì•Šìœ¼ë©´ íˆ¬ì ê²°ì •ì— ì–´ë ¤ì›€ì„ ê²ªì„ ìˆ˜ ìˆìœ¼ë©°, íˆ¬ì ê³„íšì„ ì„¸ìš°ëŠ” ê²ƒë„ ì–´ë µìŠµë‹ˆë‹¤. ì¬ë¬´ ëª©í‘œë¥¼ ì„¤ì •í•˜ê³ , ê·¸ì— ë§ëŠ” íˆ¬ì ê³„íšì„ ì„¸ìš°ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.';
            resultMessage += '</p></div>';
            
            // Information Processing Style
            resultMessage += '<div style="margin-bottom: 15px;">';
            resultMessage += '<h4 style="color: #333; margin-bottom: 5px;">Information Processing Style</h4>';
            resultMessage += '<p style="color: #666; line-height: 1.6;">';
            
            const infoScore = profile.answers?.q7 || 1;
            resultMessage += `ì •ë³´ ì²˜ë¦¬ ìŠ¤íƒ€ì¼ ì ìˆ˜ê°€ <strong>${infoScore === 1 ? '-2.0' : infoScore === 2 ? '-1.0' : infoScore === 3 ? '0' : infoScore === 4 ? '1.0' : '2.0'}ì </strong>ìœ¼ë¡œ ë‚˜ì™”ìŠµë‹ˆë‹¤. `;
            
            resultMessage += 'ì´ëŠ” íˆ¬ììê°€ ì •ë³´ë¥¼ ì ê·¹ì ìœ¼ë¡œ ìˆ˜ì§‘í•˜ê³  ë¶„ì„í•˜ëŠ” ê²ƒì„ ì–´ë ¤ì›Œí•œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. íˆ¬ì ê²°ì •ì„ ë‚´ë¦´ ë•ŒëŠ” ì¶©ë¶„í•œ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ë¶„ì„í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. íˆ¬ì ê´€ë ¨ ì •ë³´ë¥¼ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì°¾ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.';
            resultMessage += '</p></div>';
            
            // Investment Fear
            resultMessage += '<div style="margin-bottom: 15px;">';
            resultMessage += '<h4 style="color: #333; margin-bottom: 5px;">Investment Fear</h4>';
            resultMessage += '<p style="color: #666; line-height: 1.6;">';
            
            const fearScore = profile.answers?.q9 || 1;
            resultMessage += `íˆ¬ì ë‘ë ¤ì›€ ì ìˆ˜ê°€ <strong>${fearScore === 1 ? '-2.0' : fearScore === 2 ? '-1.0' : fearScore === 3 ? '0' : fearScore === 4 ? '1.0' : '2.0'}ì </strong>ìœ¼ë¡œ ë‚˜ì™”ìŠµë‹ˆë‹¤. `;
            
            resultMessage += 'ì´ëŠ” íˆ¬ìì— ëŒ€í•œ ë‘ë ¤ì›€ì´ í¬ì§€ ì•Šë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ, ìœ„í—˜ ê°ìˆ˜ì„±ì´ ë§¤ìš° ë‚®ê¸° ë•Œë¬¸ì— ì ê·¹ì ì¸ íˆ¬ìë¥¼ í•˜ê¸°ëŠ” ì–´ë ¤ìš¸ ê²ƒì…ë‹ˆë‹¤. ì•ˆì •ì ì¸ ìì‚°ì— íˆ¬ìí•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.';
            resultMessage += '</p></div>';
            
            // Investment Confidence
            resultMessage += '<div style="margin-bottom: 15px;">';
            resultMessage += '<h4 style="color: #333; margin-bottom: 5px;">Investment Confidence</h4>';
            resultMessage += '<p style="color: #666; line-height: 1.6;">';
            
            const confidenceScore = profile.answers?.q10 || 1;
            resultMessage += `íˆ¬ì ìì‹ ê° ì ìˆ˜ê°€ <strong>${confidenceScore === 1 ? '-3.0' : confidenceScore === 2 ? '-1.5' : confidenceScore === 3 ? '0' : confidenceScore === 4 ? '1.5' : '3.0'}ì </strong>ìœ¼ë¡œ ë‚˜ì™”ìŠµë‹ˆë‹¤. `;
            
            resultMessage += 'ì´ëŠ” íˆ¬ìì— ëŒ€í•œ ìì‹ ê°ì´ ë¶€ì¡±í•˜ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ìì‹ ê°ì´ ë¶€ì¡±í•˜ë©´ íˆ¬ì ê²°ì •ì„ ë‚´ë¦¬ëŠ” ê²ƒì´ ì–´ë ¤ì›Œì§€ê³ , íˆ¬ì ì„±ê³¼ì— ëŒ€í•œ ë§Œì¡±ë„ê°€ ë‚®ì•„ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìì‹ ê°ì„ ë†’ì´ê¸° ìœ„í•´ íˆ¬ì ê´€ë ¨ ì§€ì‹ì„ ìŠµë“í•˜ê³ , íˆ¬ì ê²½í—˜ì„ ìŒ“ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.';
            resultMessage += '</p></div>';
            
            // Overall Evaluation
            resultMessage += '<div style="margin-bottom: 15px; background: #e7f0ff; padding: 15px; border-radius: 8px;">';
            resultMessage += '<h4 style="color: #1454FE; margin-bottom: 10px;">ì¢…í•© í‰ê°€</h4>';
            resultMessage += '<p style="color: #333; line-height: 1.6; margin-bottom: 10px;">';
            resultMessage += `ê·€í•˜ì˜ íˆ¬ì ì„±í–¥ì€ <strong>${profile.personality_type || 'ë¶„ì„ ì¤‘'}</strong>ì…ë‹ˆë‹¤. `;
            
            if (profile.personality_type === 'ê³µê²©íˆ¬ìí˜•') {
                resultMessage += 'ë†’ì€ ìˆ˜ìµì„ ì¶”êµ¬í•˜ë©° ìœ„í—˜ì„ ê°ìˆ˜í•  ìˆ˜ ìˆëŠ” íˆ¬ììì…ë‹ˆë‹¤. ì„±ì¥ì£¼, í…Œë§ˆì£¼, í•´ì™¸ì£¼ì‹ ë“± ê³ ìœ„í—˜ ê³ ìˆ˜ìµ ìƒí’ˆì— ì í•©í•©ë‹ˆë‹¤.';
            } else if (profile.personality_type === 'ì ê·¹íˆ¬ìí˜•') {
                resultMessage += 'ìˆ˜ìµì„ ì¶”êµ¬í•˜ë©´ì„œë„ ì¼ì • ìˆ˜ì¤€ì˜ ìœ„í—˜ ê´€ë¦¬ë¥¼ í•˜ëŠ” íˆ¬ììì…ë‹ˆë‹¤. ì„±ì¥ ê°€ëŠ¥ì„±ì´ ë†’ì€ ìš°ëŸ‰ì£¼ì™€ ì¼ë¶€ ì„±ì¥ì£¼ë¥¼ ì¡°í•©í•œ í¬íŠ¸í´ë¦¬ì˜¤ê°€ ì í•©í•©ë‹ˆë‹¤.';
            } else if (profile.personality_type === 'ìœ„í—˜ì¤‘ë¦½í˜•') {
                resultMessage += 'ì•ˆì •ì„±ê³¼ ìˆ˜ìµì„±ì˜ ê· í˜•ì„ ì¶”êµ¬í•˜ëŠ” íˆ¬ììì…ë‹ˆë‹¤. ëŒ€í˜• ìš°ëŸ‰ì£¼ ì¤‘ì‹¬ìœ¼ë¡œ ì¼ë¶€ ì„±ì¥ì£¼ë¥¼ í¬í•¨í•œ ê· í˜•ì¡íŒ í¬íŠ¸í´ë¦¬ì˜¤ê°€ ì í•©í•©ë‹ˆë‹¤.';
            } else if (profile.personality_type === 'ì•ˆì •ì¶”êµ¬í˜•') {
                resultMessage += 'ì›ê¸ˆ ë³´ì¡´ì„ ì¤‘ì‹œí•˜ë©° ì•ˆì •ì ì¸ ìˆ˜ìµì„ ì¶”êµ¬í•˜ëŠ” íˆ¬ììì…ë‹ˆë‹¤. ë°°ë‹¹ì£¼, ëŒ€í˜• ìš°ëŸ‰ì£¼ ì¤‘ì‹¬ì˜ ì•ˆì •ì ì¸ í¬íŠ¸í´ë¦¬ì˜¤ê°€ ì í•©í•©ë‹ˆë‹¤.';
            } else {
                resultMessage += 'ì›ê¸ˆ ë³´ì¡´ì„ ìµœìš°ì„ ìœ¼ë¡œ í•˜ëŠ” ë³´ìˆ˜ì ì¸ íˆ¬ììì…ë‹ˆë‹¤. ì˜ˆê¸ˆ, ì±„ê¶Œ, ëŒ€í˜• ìš°ëŸ‰ì£¼ ìœ„ì£¼ì˜ ë§¤ìš° ì•ˆì •ì ì¸ í¬íŠ¸í´ë¦¬ì˜¤ê°€ ì í•©í•©ë‹ˆë‹¤.';
            }
            
            resultMessage += '</p>';
            resultMessage += '<p style="color: #333; line-height: 1.6;">';
            resultMessage += 'íˆ¬ìëŠ” ìì‹ ì˜ ì„±í–¥ì— ë§ëŠ” ì „ëµì„ ì„ íƒí•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ìœ„í—˜ì„ ë„ˆë¬´ íšŒí”¼í•˜ë©´ ìˆ˜ìµ ê¸°íšŒë¥¼ ë†“ì¹  ìˆ˜ ìˆê³ , ê³¼ë„í•œ ìœ„í—˜ì„ ê°ìˆ˜í•˜ë©´ í° ì†ì‹¤ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìì‹ ì˜ íˆ¬ì ì„±í–¥ì„ ì˜ ì´í•´í•˜ê³ , ê·¸ì— ë§ëŠ” íˆ¬ì ì „ëµì„ ìˆ˜ë¦½í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.';
            resultMessage += '</p>';
            resultMessage += '</div>';
            
            resultMessage += '</div>';
            
            addMessage(resultMessage, 'ai');
            
            // ì¶”ê°€ ì•ˆë‚´ ë©”ì‹œì§€
            setTimeout(() => {
                addMessage('íˆ¬ì ì„±í–¥ì„ ë°”íƒ•ìœ¼ë¡œ êµ¬ì²´ì ì¸ ì¢…ëª© ì¶”ì²œì„ ì›í•˜ì‹œë©´ "ë‚´ íˆ¬ì ì„±í–¥ì— ë§ëŠ” ì½”ìŠ¤ë‹¥ ì¢…ëª© ì¶”ì²œí•´ì¤˜" ë¼ê³  ë¬¼ì–´ë³´ì„¸ìš”!', 'ai');
            }, 1000);
            
        } else {
            addMessage('íˆ¬ì ì„±í–¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ai');
        }
    } catch (error) {
        console.error('ì„¤ë¬¸ ê²°ê³¼ í‘œì‹œ ì˜¤ë¥˜:', error);
        addMessage('ì„¤ë¬¸ ê²°ê³¼ë¥¼ í‘œì‹œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ai');
    }
}

// ì‹œì¥ ë¶„ì„ ìš”ì²­ í•¨ìˆ˜
async function requestMarketAnalysis() {
    const marketAnalysisBtn = document.getElementById('marketAnalysisBtn');
    if (marketAnalysisBtn) {
        marketAnalysisBtn.disabled = true;
        marketAnalysisBtn.innerHTML = '<span style="font-size: 20px;">â³</span> ì‹œì¥ ë¶„ì„ ì¤‘...';
    }
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    addMessage('[ì‹¤ì‹œê°„ ì‹œì¥ ë¶„ì„ ìš”ì²­] ìµœì‹  ë‰´ìŠ¤ ê°ì • ë¶„ì„ì„ ê¸°ë°˜ìœ¼ë¡œ í˜„ì¬ ì‹œì¥ ìƒí™©ì„ ë¶„ì„í•´ì£¼ì„¸ìš”', 'user');
    
    try {
        // ë¹ ë¥¸ ì‹œì¥ ë¶„ì„ API í˜¸ì¶œ
        const response = await fetch('/api/market-analysis-quick', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Session-ID': getSessionId()
            },
            body: JSON.stringify({})
        });
        
        const data = await response.json();
        
        if (data.success) {
            // ë¹ ë¥¸ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            addMessage(data.response, 'ai');
            
            // ì¶”ê°€ ì •ë³´ê°€ ìˆìœ¼ë©´ í‘œì‹œ
            if (data.data && data.data.keywords && data.data.keywords.length > 0) {
                const keywordInfo = `\nğŸ“Œ **ì£¼ìš” í‚¤ì›Œë“œ**: ${data.data.keywords.slice(0, 5).map(k => k.keyword).join(', ')}`;
                addMessage(keywordInfo, 'ai');
            }
        } else {
            addMessage('ì‹œì¥ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ai');
        }
    } catch (error) {
        console.error('ì‹œì¥ ë¶„ì„ ì˜¤ë¥˜:', error);
        addMessage('ì‹œì¥ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ai');
    } finally {
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        if (marketAnalysisBtn) {
            setTimeout(() => {
                marketAnalysisBtn.disabled = false;
                marketAnalysisBtn.innerHTML = '<span style="font-size: 20px;">ğŸ“Š</span> ì‹¤ì‹œê°„ ì‹œì¥ ë¶„ì„ (AI ë‰´ìŠ¤ ë¶„ì„ ê¸°ë°˜)';
            }, 3000);
        }
    }
}
</script>
{% endblock %} 
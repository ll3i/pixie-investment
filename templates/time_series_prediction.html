{% extends 'layout.html' %}

{% block title %}ì‹œê³„ì—´ ì˜ˆì¸¡ - MINERVA{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* ë©”ì¸ í˜ì´ì§€ì™€ ì¼ê´€ëœ ìŠ¤íƒ€ì¼ */
    body {
        background-color: #f0f5ff;
        background-image: linear-gradient(135deg, #f0f5ff 0%, #e6f0ff 100%);
        font-family: 'Noto Sans KR', sans-serif;
    }
    
    .prediction-card {
        background: linear-gradient(135deg, #1e3a8a, #2563eb);
        border-radius: 16px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 10px 25px rgba(30, 58, 138, 0.2);
    }
    
    .feature-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .feature-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
    }
    
    .trend-up { color: #10b981; font-weight: 600; }
    .trend-down { color: #ef4444; font-weight: 600; }
    .trend-neutral { color: #6b7280; font-weight: 600; }
    
    .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        border: none;
        box-shadow: 0 8px 15px rgba(29, 78, 216, 0.3);
        font-weight: 600;
        padding: 1rem 2rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 20px rgba(29, 78, 216, 0.4);
        background: linear-gradient(135deg, #2563eb, #1e40af);
    }
    
    .search-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }
    
    .form-control {
        border-radius: 12px;
        border: 2px solid #e5e7eb;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <div class="hero-text">
                    <h1>ğŸ“Š ì‹¤ì‹œê°„ ì£¼ê°€ ì‹œê³„ì—´ ì˜ˆì¸¡</h1>
                    <p>ì‹¤ì œ ìˆ˜ì§‘ëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì£¼ìš” ì¢…ëª©ì˜ ë¯¸ë˜ ê°€ê²©ì„ ì˜ˆì¸¡í•©ë‹ˆë‹¤. AIì™€ í†µê³„ì  ë¶„ì„ì„ í™œìš©í•œ ì •í™•í•œ ì˜ˆì¸¡ ì„œë¹„ìŠ¤ë¥¼ ê²½í—˜í•´ë³´ì„¸ìš”.</p>
                    <div class="d-flex gap-3 mt-4">
                        <a href="#search-section" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i> ì¢…ëª© ê²€ìƒ‰í•˜ê¸°
                        </a>
                        <a href="#predictions-section" class="btn btn-outline-light">
                            <i class="fas fa-chart-line me-2"></i> ê¸°ë³¸ ì˜ˆì¸¡ ë³´ê¸°
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="text-center">
                    <i class="fas fa-chart-area fa-10x" style="color: rgba(255,255,255,0.3);"></i>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- ë©”ì¸ ì»¨í…ì¸  -->
<section class="py-5" id="search-section">
    <div class="container">
        <!-- ì¢…ëª© ê²€ìƒ‰ -->
        <div class="search-container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="h4 mb-3"><i class="fas fa-search me-2 text-primary"></i>ì¢…ëª© ê²€ìƒ‰</h2>
                    <div class="input-group">
                        <input type="text" id="stockInput" placeholder="ì¢…ëª©ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 005930, AAPL)" 
                               class="form-control form-control-lg">
                        <button onclick="predictStock()" class="btn btn-primary btn-lg">
                            <i class="fas fa-chart-line me-2"></i> ì˜ˆì¸¡ ì‹¤í–‰
                        </button>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>ì˜ˆì‹œ:</strong> 005930 (ì‚¼ì„±ì „ì), 000660 (SKí•˜ì´ë‹‰ìŠ¤), AAPL (ì• í”Œ), MSFT (ë§ˆì´í¬ë¡œì†Œí”„íŠ¸)
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loading" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">ì˜ˆì¸¡ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>

        <!-- ì˜ˆì¸¡ ê²°ê³¼ -->
        <div id="predictionResult" style="display: none;">
            <div class="prediction-card">
                <h2 id="stockTitle">ì¢…ëª© ì˜ˆì¸¡ ê²°ê³¼</h2>
                <div id="stockSummary"></div>
            </div>

            <!-- ì°¨íŠ¸ ì˜ì—­ -->
            <div class="feature-card mb-4">
                <h3 class="h5 mb-4"><i class="fas fa-chart-area me-2 text-primary"></i>ê°€ê²© ì˜ˆì¸¡ ì°¨íŠ¸</h3>
                <canvas id="predictionChart" width="400" height="200"></canvas>
            </div>

            <!-- ìƒì„¸ ì˜ˆì¸¡ ë°ì´í„° -->
            <div class="feature-card">
                <h3 class="h5 mb-4"><i class="fas fa-list me-2 text-primary"></i>ì¼ë³„ ìƒì„¸ ì˜ˆì¸¡</h3>
                <div id="detailedPredictions"></div>
            </div>
        </div>
    </div>
</section>

<!-- ê¸°ë³¸ ì˜ˆì¸¡ ì„¹ì…˜ -->
<section class="py-5 bg-light" id="predictions-section">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="h3 mb-3">ğŸ“ˆ ì£¼ìš” ì¢…ëª© ì˜ˆì¸¡ í˜„í™©</h2>
            <p class="text-muted">ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ëŠ” ì£¼ìš” ì¢…ëª©ë“¤ì˜ ì˜ˆì¸¡ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </div>
        <div id="defaultPredictions" class="row g-4">
            <!-- ì—¬ê¸°ì— ê¸°ë³¸ ì˜ˆì¸¡ë“¤ì´ ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    let predictionChart = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ì˜ˆì¸¡ ë°ì´í„° ë¡œë“œ
        document.addEventListener('DOMContentLoaded', function() {
            loadDefaultPredictions();
        });

        async function loadDefaultPredictions() {
            try {
                console.log('ê¸°ë³¸ ì˜ˆì¸¡ ë¡œë“œ ì‹œì‘...');
                const response = await fetch('/api/predictions');
                const data = await response.json();
                console.log('API ì‘ë‹µ:', data);

                if (data.success && data.time_series_forecasts) {
                    displayDefaultPredictions(data.time_series_forecasts);
                } else {
                    console.log('ì‹œê³„ì—´ ì˜ˆì¸¡ ë°ì´í„° ì—†ìŒ, ë°ì´í„° ìˆ˜ì§‘ ì•ˆë‚´ í‘œì‹œ');
                    showDataCollectionNotice();
                }
            } catch (error) {
                console.error('ê¸°ë³¸ ì˜ˆì¸¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                showDataCollectionNotice();
            }
        }

        function showDataCollectionNotice() {
            const container = document.getElementById('defaultPredictions');
            container.innerHTML = `
                <div class="col-12 text-center">
                    <div class="feature-card">
                        <i class="fas fa-database fa-3x text-primary mb-3"></i>
                        <h5>ğŸ“Š ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ ì˜ˆì¸¡ ì‹œìŠ¤í…œ</h5>
                        <p class="text-muted mb-4">
                            í˜„ì¬ ì‹œìŠ¤í…œì´ ì‹¤ì œ ìˆ˜ì§‘ëœ ì£¼ì‹ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³  ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>
                            ì•„ë˜ ì¢…ëª© ì½”ë“œë¥¼ ì§ì ‘ ì…ë ¥í•´ì„œ ì˜ˆì¸¡ì„ ì‹¤í–‰í•´ë³´ì„¸ìš”.
                        </p>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">ğŸ‡°ğŸ‡· í•œêµ­ ì£¼ì‹ (ì˜ˆì‹œ)</h6>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <button onclick="predictStock('000020')" class="btn btn-sm btn-outline-primary">000020</button>
                                    <button onclick="predictStock('000040')" class="btn btn-sm btn-outline-primary">000040</button>
                                    <button onclick="predictStock('000050')" class="btn btn-sm btn-outline-primary">000050</button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì£¼ì‹ (ì˜ˆì‹œ)</h6>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <button onclick="predictStock('AAPL')" class="btn btn-sm btn-outline-primary">AAPL</button>
                                    <button onclick="predictStock('MSFT')" class="btn btn-sm btn-outline-primary">MSFT</button>
                                    <button onclick="predictStock('GOOGL')" class="btn btn-sm btn-outline-primary">GOOGL</button>
                                </div>
                            </div>
                        </div>
                        <button onclick="loadDefaultPredictions()" class="btn btn-primary">
                            <i class="fas fa-refresh me-2"></i>ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                        </button>
                    </div>
                </div>
            `;
        }

        function displayDefaultPredictions(forecasts) {
            const container = document.getElementById('defaultPredictions');
            
            forecasts.forEach(forecast => {
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-3';
                
                const trendIcon = forecast.current_info.trend === 'bullish' ? 'ğŸ“ˆ' : 
                                forecast.current_info.trend === 'bearish' ? 'ğŸ“‰' : 'â¡ï¸';
                
                const trendClass = forecast.current_info.trend === 'bullish' ? 'trend-up' : 
                                 forecast.current_info.trend === 'bearish' ? 'trend-down' : 'trend-neutral';
                
                card.innerHTML = `
                    <div class="feature-card h-100">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title">${trendIcon} ${forecast.stock_name}</h5>
                            <small class="text-muted">${forecast.market}</small>
                        </div>
                        <div class="mb-3">
                            <p class="mb-2"><strong>í˜„ì¬ê°€:</strong> <span class="${trendClass}">${forecast.current_info.current_price.toLocaleString()}ì›/ë‹¬ëŸ¬</span></p>
                            <p class="mb-2"><strong>ë³€ë™ì„±:</strong> ${forecast.current_info.volatility}%</p>
                            <p class="mb-2"><strong>7ì¼ ì˜ˆì¸¡ ë²”ìœ„:</strong><br>
                               <small>${forecast.forecast_summary.min_predicted_price.toLocaleString()} ~ 
                               ${forecast.forecast_summary.max_predicted_price.toLocaleString()}</small></p>
                            <p class="mb-0"><strong>í‰ê·  ì‹ ë¢°ë„:</strong> ${(forecast.forecast_summary.avg_confidence * 100).toFixed(1)}%</p>
                        </div>
                        <button onclick="predictStock('${forecast.stock_code}')" 
                                class="btn btn-outline-primary w-100">
                            <i class="fas fa-chart-line me-2"></i>ìƒì„¸ ì˜ˆì¸¡ ë³´ê¸°
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        async function predictStock(stockCode = null) {
            const stockInput = document.getElementById('stockInput');
            const code = stockCode || stockInput.value.trim().toUpperCase();
            
            if (!code) {
                alert('ì¢…ëª©ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('loading').style.display = 'block';
            document.getElementById('predictionResult').style.display = 'none';
            document.getElementById('defaultPredictions').style.display = 'none';

            try {
                const response = await fetch('/api/time_series_prediction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        stock_code: code,
                        days: 7
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    displayPredictionResult(data.prediction);
                } else {
                    alert(`ì˜ˆì¸¡ ì‹¤íŒ¨: ${data.error}`);
                }

            } catch (error) {
                console.error('ì˜ˆì¸¡ ìš”ì²­ ì‹¤íŒ¨:', error);
                alert('ì˜ˆì¸¡ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayPredictionResult(prediction) {
            // íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
            document.getElementById('stockTitle').textContent = 
                `${prediction.stock_name} (${prediction.stock_code})`;

            // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
            const trendText = prediction.current_info.trend === 'bullish' ? 'ìƒìŠ¹ ì¶”ì„¸' : 
                            prediction.current_info.trend === 'bearish' ? 'í•˜ë½ ì¶”ì„¸' : 'ë³´í•©';
            
            document.getElementById('stockSummary').innerHTML = `
                í˜„ì¬ê°€: ${prediction.current_info.current_price.toLocaleString()}ì›/ë‹¬ëŸ¬ | 
                ì¶”ì„¸: ${trendText} | 
                ë³€ë™ì„±: ${prediction.current_info.volatility}%
            `;

            // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            drawPredictionChart(prediction);

            // ìƒì„¸ ì˜ˆì¸¡ í‘œì‹œ
            displayDetailedPredictions(prediction.predictions);

            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('predictionResult').style.display = 'block';
        }

        function drawPredictionChart(prediction) {
            const ctx = document.getElementById('predictionChart').getContext('2d');
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (predictionChart) {
                predictionChart.destroy();
            }

            const days = prediction.predictions.map((p, i) => `${i + 1}ì¼ í›„`);
            const prices = prediction.predictions.map(p => p.predicted_price);
            const confidences = prediction.predictions.map(p => p.confidence * 100);

            predictionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['í˜„ì¬', ...days],
                    datasets: [{
                        label: 'ì˜ˆì¸¡ ê°€ê²©',
                        data: [prediction.current_info.current_price, ...prices],
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.3
                    }, {
                        label: 'ì‹ ë¢°ë„ (%)',
                        data: [90, ...confidences],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            position: 'left'
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }

        function displayDetailedPredictions(predictions) {
            const container = document.getElementById('detailedPredictions');
            container.innerHTML = '';

            predictions.forEach((pred, index) => {
                const changePercent = pred.price_change_percent;
                const trendClass = changePercent > 0 ? 'trend-up' : 
                                 changePercent < 0 ? 'trend-down' : 'trend-neutral';

                const predDiv = document.createElement('div');
                predDiv.className = 'd-flex justify-content-between align-items-center p-3 mb-2 bg-light rounded';
                predDiv.innerHTML = `
                    <div>
                        <span class="fw-medium">${pred.day}ì¼ í›„</span>
                        <span class="ms-2 ${trendClass}">${pred.predicted_price.toLocaleString()}ì›/ë‹¬ëŸ¬</span>
                        <span class="ms-2 ${trendClass}">(${changePercent > 0 ? '+' : ''}${changePercent.toFixed(1)}%)</span>
                    </div>
                    <div>
                        <small class="text-muted">ì‹ ë¢°ë„: ${(pred.confidence * 100).toFixed(1)}%</small>
                    </div>
                `;
                container.appendChild(predDiv);
            });
        }

        // Enter í‚¤ë¡œ ê²€ìƒ‰
        document.getElementById('stockInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                predictStock();
            }
        });
</script>
{% endblock %}
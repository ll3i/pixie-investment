{% extends 'layout.html' %}

{% block title %}시계열 예측 - MINERVA{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* 메인 페이지와 일관된 스타일 */
    body {
        background-color: #f0f5ff;
        background-image: linear-gradient(135deg, #f0f5ff 0%, #e6f0ff 100%);
        font-family: 'Noto Sans KR', sans-serif;
    }
    
    .prediction-card {
        background: linear-gradient(135deg, #1e3a8a, #2563eb);
        border-radius: 16px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 10px 25px rgba(30, 58, 138, 0.2);
    }
    
    .feature-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .feature-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
    }
    
    .trend-up { color: #10b981; font-weight: 600; }
    .trend-down { color: #ef4444; font-weight: 600; }
    .trend-neutral { color: #6b7280; font-weight: 600; }
    
    .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        border: none;
        box-shadow: 0 8px 15px rgba(29, 78, 216, 0.3);
        font-weight: 600;
        padding: 1rem 2rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 20px rgba(29, 78, 216, 0.4);
        background: linear-gradient(135deg, #2563eb, #1e40af);
    }
    
    .search-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }
    
    .form-control {
        border-radius: 12px;
        border: 2px solid #e5e7eb;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <div class="hero-text">
                    <h1>📊 실시간 주가 시계열 예측</h1>
                    <p>실제 수집된 데이터를 바탕으로 주요 종목의 미래 가격을 예측합니다. AI와 통계적 분석을 활용한 정확한 예측 서비스를 경험해보세요.</p>
                    <div class="d-flex gap-3 mt-4">
                        <a href="#search-section" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i> 종목 검색하기
                        </a>
                        <a href="#predictions-section" class="btn btn-outline-light">
                            <i class="fas fa-chart-line me-2"></i> 기본 예측 보기
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="text-center">
                    <i class="fas fa-chart-area fa-10x" style="color: rgba(255,255,255,0.3);"></i>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- 메인 컨텐츠 -->
<section class="py-5" id="search-section">
    <div class="container">
        <!-- 종목 검색 -->
        <div class="search-container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="h4 mb-3"><i class="fas fa-search me-2 text-primary"></i>종목 검색</h2>
                    <div class="input-group">
                        <input type="text" id="stockInput" placeholder="종목코드를 입력하세요 (예: 005930, AAPL)" 
                               class="form-control form-control-lg">
                        <button onclick="predictStock()" class="btn btn-primary btn-lg">
                            <i class="fas fa-chart-line me-2"></i> 예측 실행
                        </button>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>예시:</strong> 005930 (삼성전자), 000660 (SK하이닉스), AAPL (애플), MSFT (마이크로소프트)
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 로딩 상태 -->
        <div id="loading" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">예측을 생성하고 있습니다...</p>
        </div>

        <!-- 예측 결과 -->
        <div id="predictionResult" style="display: none;">
            <div class="prediction-card">
                <h2 id="stockTitle">종목 예측 결과</h2>
                <div id="stockSummary"></div>
            </div>

            <!-- 차트 영역 -->
            <div class="feature-card mb-4">
                <h3 class="h5 mb-4"><i class="fas fa-chart-area me-2 text-primary"></i>가격 예측 차트</h3>
                <canvas id="predictionChart" width="400" height="200"></canvas>
            </div>

            <!-- 상세 예측 데이터 -->
            <div class="feature-card">
                <h3 class="h5 mb-4"><i class="fas fa-list me-2 text-primary"></i>일별 상세 예측</h3>
                <div id="detailedPredictions"></div>
            </div>
        </div>
    </div>
</section>

<!-- 기본 예측 섹션 -->
<section class="py-5 bg-light" id="predictions-section">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="h3 mb-3">📈 주요 종목 예측 현황</h2>
            <p class="text-muted">실시간으로 업데이트되는 주요 종목들의 예측 데이터를 확인하세요</p>
        </div>
        <div id="defaultPredictions" class="row g-4">
            <!-- 여기에 기본 예측들이 로드됩니다 -->
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    let predictionChart = null;

        // 페이지 로드 시 기본 예측 데이터 로드
        document.addEventListener('DOMContentLoaded', function() {
            loadDefaultPredictions();
        });

        async function loadDefaultPredictions() {
            try {
                console.log('기본 예측 로드 시작...');
                const response = await fetch('/api/predictions');
                const data = await response.json();
                console.log('API 응답:', data);

                if (data.success && data.time_series_forecasts) {
                    displayDefaultPredictions(data.time_series_forecasts);
                } else {
                    console.log('시계열 예측 데이터 없음, 데이터 수집 안내 표시');
                    showDataCollectionNotice();
                }
            } catch (error) {
                console.error('기본 예측 로드 실패:', error);
                showDataCollectionNotice();
            }
        }

        function showDataCollectionNotice() {
            const container = document.getElementById('defaultPredictions');
            container.innerHTML = `
                <div class="col-12 text-center">
                    <div class="feature-card">
                        <i class="fas fa-database fa-3x text-primary mb-3"></i>
                        <h5>📊 실제 데이터 기반 예측 시스템</h5>
                        <p class="text-muted mb-4">
                            현재 시스템이 실제 수집된 주식 데이터를 로드하고 분석하고 있습니다.<br>
                            아래 종목 코드를 직접 입력해서 예측을 실행해보세요.
                        </p>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">🇰🇷 한국 주식 (예시)</h6>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <button onclick="predictStock('000020')" class="btn btn-sm btn-outline-primary">000020</button>
                                    <button onclick="predictStock('000040')" class="btn btn-sm btn-outline-primary">000040</button>
                                    <button onclick="predictStock('000050')" class="btn btn-sm btn-outline-primary">000050</button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">🇺🇸 미국 주식 (예시)</h6>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <button onclick="predictStock('AAPL')" class="btn btn-sm btn-outline-primary">AAPL</button>
                                    <button onclick="predictStock('MSFT')" class="btn btn-sm btn-outline-primary">MSFT</button>
                                    <button onclick="predictStock('GOOGL')" class="btn btn-sm btn-outline-primary">GOOGL</button>
                                </div>
                            </div>
                        </div>
                        <button onclick="loadDefaultPredictions()" class="btn btn-primary">
                            <i class="fas fa-refresh me-2"></i>데이터 다시 로드
                        </button>
                    </div>
                </div>
            `;
        }

        function displayDefaultPredictions(forecasts) {
            const container = document.getElementById('defaultPredictions');
            
            forecasts.forEach(forecast => {
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-3';
                
                const trendIcon = forecast.current_info.trend === 'bullish' ? '📈' : 
                                forecast.current_info.trend === 'bearish' ? '📉' : '➡️';
                
                const trendClass = forecast.current_info.trend === 'bullish' ? 'trend-up' : 
                                 forecast.current_info.trend === 'bearish' ? 'trend-down' : 'trend-neutral';
                
                card.innerHTML = `
                    <div class="feature-card h-100">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title">${trendIcon} ${forecast.stock_name}</h5>
                            <small class="text-muted">${forecast.market}</small>
                        </div>
                        <div class="mb-3">
                            <p class="mb-2"><strong>현재가:</strong> <span class="${trendClass}">${forecast.current_info.current_price.toLocaleString()}원/달러</span></p>
                            <p class="mb-2"><strong>변동성:</strong> ${forecast.current_info.volatility}%</p>
                            <p class="mb-2"><strong>7일 예측 범위:</strong><br>
                               <small>${forecast.forecast_summary.min_predicted_price.toLocaleString()} ~ 
                               ${forecast.forecast_summary.max_predicted_price.toLocaleString()}</small></p>
                            <p class="mb-0"><strong>평균 신뢰도:</strong> ${(forecast.forecast_summary.avg_confidence * 100).toFixed(1)}%</p>
                        </div>
                        <button onclick="predictStock('${forecast.stock_code}')" 
                                class="btn btn-outline-primary w-100">
                            <i class="fas fa-chart-line me-2"></i>상세 예측 보기
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        async function predictStock(stockCode = null) {
            const stockInput = document.getElementById('stockInput');
            const code = stockCode || stockInput.value.trim().toUpperCase();
            
            if (!code) {
                alert('종목코드를 입력해주세요.');
                return;
            }

            // UI 상태 업데이트
            document.getElementById('loading').style.display = 'block';
            document.getElementById('predictionResult').style.display = 'none';
            document.getElementById('defaultPredictions').style.display = 'none';

            try {
                const response = await fetch('/api/time_series_prediction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        stock_code: code,
                        days: 7
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    displayPredictionResult(data.prediction);
                } else {
                    alert(`예측 실패: ${data.error}`);
                }

            } catch (error) {
                console.error('예측 요청 실패:', error);
                alert('예측 요청 중 오류가 발생했습니다.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayPredictionResult(prediction) {
            // 타이틀 업데이트
            document.getElementById('stockTitle').textContent = 
                `${prediction.stock_name} (${prediction.stock_code})`;

            // 요약 정보 업데이트
            const trendText = prediction.current_info.trend === 'bullish' ? '상승 추세' : 
                            prediction.current_info.trend === 'bearish' ? '하락 추세' : '보합';
            
            document.getElementById('stockSummary').innerHTML = `
                현재가: ${prediction.current_info.current_price.toLocaleString()}원/달러 | 
                추세: ${trendText} | 
                변동성: ${prediction.current_info.volatility}%
            `;

            // 차트 그리기
            drawPredictionChart(prediction);

            // 상세 예측 표시
            displayDetailedPredictions(prediction.predictions);

            // 결과 표시
            document.getElementById('predictionResult').style.display = 'block';
        }

        function drawPredictionChart(prediction) {
            const ctx = document.getElementById('predictionChart').getContext('2d');
            
            // 기존 차트 제거
            if (predictionChart) {
                predictionChart.destroy();
            }

            const days = prediction.predictions.map((p, i) => `${i + 1}일 후`);
            const prices = prediction.predictions.map(p => p.predicted_price);
            const confidences = prediction.predictions.map(p => p.confidence * 100);

            predictionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['현재', ...days],
                    datasets: [{
                        label: '예측 가격',
                        data: [prediction.current_info.current_price, ...prices],
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.3
                    }, {
                        label: '신뢰도 (%)',
                        data: [90, ...confidences],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            position: 'left'
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }

        function displayDetailedPredictions(predictions) {
            const container = document.getElementById('detailedPredictions');
            container.innerHTML = '';

            predictions.forEach((pred, index) => {
                const changePercent = pred.price_change_percent;
                const trendClass = changePercent > 0 ? 'trend-up' : 
                                 changePercent < 0 ? 'trend-down' : 'trend-neutral';

                const predDiv = document.createElement('div');
                predDiv.className = 'd-flex justify-content-between align-items-center p-3 mb-2 bg-light rounded';
                predDiv.innerHTML = `
                    <div>
                        <span class="fw-medium">${pred.day}일 후</span>
                        <span class="ms-2 ${trendClass}">${pred.predicted_price.toLocaleString()}원/달러</span>
                        <span class="ms-2 ${trendClass}">(${changePercent > 0 ? '+' : ''}${changePercent.toFixed(1)}%)</span>
                    </div>
                    <div>
                        <small class="text-muted">신뢰도: ${(pred.confidence * 100).toFixed(1)}%</small>
                    </div>
                `;
                container.appendChild(predDiv);
            });
        }

        // Enter 키로 검색
        document.getElementById('stockInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                predictStock();
            }
        });
</script>
{% endblock %}
